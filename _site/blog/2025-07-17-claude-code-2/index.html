<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="dcterms.date" content="2025-07-17">
<title>How I‚Äôm using Claude Code to write R code | Simon P. Couch ‚Äì Simon P. Couch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/cabin.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a2d2da6447bc21d3e680c795c75d6b9d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DDB8R0B1ZW"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DDB8R0B1ZW', { 'anonymize_ip': true});
</script>
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/cabin.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Simon P. Couch</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://www.github.com/simonpcouch/website" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">How I‚Äôm using Claude Code to write R code</h1>
            <p class="subtitle lead">Giving Claude Code the ability to peruse R package documentation via MCP is so, so helpful.</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 17, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>A couple months ago, I <a href="https://www.simonpcouch.com/blog/2025-03-26-claude-code/">wrote a bit</a> about how I was using Claude Code to help me write R code. At the time, I mostly just shared my impressions of working with the tool and some prompting tips. In the month or two after I wrote the post, my usage waned; I was mostly back to using LLMs only for shorter, more narrowly-scoped tasks. A few weeks ago, though, we put together some tooling that has helped me get much more out of the tool and thus made me interested in using it more often again.</p>
<p>The tl;dr:</p>
<ul>
<li>Give models the ability to read R package documentation using the Model Context Protocol</li>
<li>Use slash commands in combination with references to external documentation in CLAUDE.md</li>
<li>
<code>/compact</code> stinks</li>
</ul>
<section id="context" class="level2"><h2 class="anchored" data-anchor-id="context">Context</h2>
<p>When working with Claude Code and other coding assistants, I‚Äôd often find that I‚Äôd spend the first couple minutes interacting with the tool just compiling the right context to get it situated with the project. Only once the model had seen large portions of the codebase, a good bit of related documentation, and a few rounds of edit rejections from me did I start to accept edits from the tool. At some point, rather than bumbling through that process of context building every time I started a new chat, I decided I‚Äôd just pay attention to the things I was saying again and again and put the effort in to get them into context from the get-go.</p>
<p>In this section, I‚Äôll outline what I‚Äôm keeping in my CLAUDE.md files and how I‚Äôm making sure Claude Code actually integrates their contents into the changes it proposes.</p>
<section id="project-context" class="level3"><h3 class="anchored" data-anchor-id="project-context">Project context</h3>
<p>In most R projects I work on regularly, now, there‚Äôs a CLAUDE.md file in the project directory. This file contains context on the project itself rather than context generally about my preferences and workflows. Generally, these files contain 1) instructions to read project source, 2) instructions to read about the dependencies of the project, and 3) context on the project that I add to as I go.</p>
<p><strong>1) Project source</strong>: Most of my project-level CLAUDE.md files contain some instruction like: ‚ÄúAI assistants should read every file in <code>R/</code>.‚Äù If you‚Äôre working on an R project other than a package, you might write ‚Äúevery <code>.R</code> file.‚Äù This may seem overboard, but in my experience, I often needed the model to read just about everything before I got anything useful out of it anyway.</p>
<p><strong>2) Project dependencies</strong>: Often, R packages I‚Äôm working on rely on new and/or less-popular R packages, which LLMs might not be familiar with. How can I teach models about these R packages, or give them the ability to go peruse the package documentation themselves? This problem comes up again and again when using LLMs for code assistance, and we‚Äôve put together some solutions here that we‚Äôre really excited about.</p>
<p>The <a href="https://posit-dev.github.io/btw/index.html">btw</a> package provides a number of tools that make it easier to provide context to LLMs. A subset of those tools are focused on LLM-friendly R package documentation: namespaces, help-pages, vignettes, etc. As of a few weeks ago, it‚Äôs now possible to surface those tools as an <a href="https://posit-dev.github.io/btw/reference/mcp.html">MCP server</a>, meaning that if Claude Code comes across some function it hasn‚Äôt seen before, it can pull up the documentation page for the function in the same way I might and read up on it before responding.</p>
<p>To <strong>set up Claude Code with an MCP server for R package documentation</strong>, install btw with <code>pak::pak("posit-dev/btw")</code> and then paste the following into a terminal:</p>
<pre><code>claude mcp add -s "user" r-btw -- Rscript -e "btw::btw_mcp_server(tools = 'docs')"</code></pre>
<p>From then on, every time you start Claude Code, the app will have a set of tools available that allow it to read up on any R packages you have installed. So, while you‚Äôre chatting, you could just write ‚Äúread ?dplyr::filter and then‚Ä¶‚Äù; before Claude Code does whatever you asked it to do, it will pull up the help page at <code><a href="https://dplyr.tidyverse.org/reference/filter.html">?dplyr::filter</a></code>. The real value here, though, is in having Claude Code read the documentation of some set of functions every time you start <code>claude</code> up. So, for example, I have <a href="https://github.com/simonpcouch/predictive/blob/859755e8bdb3ad381b46cf6f3dfbe2c2aa564ff0/CLAUDE.md#L23-L34">in one <code>CLAUDE.md</code> file</a>:</p>
<blockquote class="blockquote">
<p>Future AI assistants working on this project should read these help pages via btw tools:</p>
<ul>
<li><code><a href="https://mirai.r-lib.org/reference/mirai.html">mirai::mirai()</a></code></li>
<li><code><a href="https://ellmer.tidyverse.org/reference/Chat.html">ellmer::Chat()</a></code></li>
<li><code><a href="https://ellmer.tidyverse.org/reference/tool.html">ellmer::tool()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/shinychat/man/chat_ui.html">shinychat::chat_ui()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/shiny/man/ExtendedTask.html">shiny::ExtendedTask</a></code></li>
</ul>
</blockquote>
<p>I drop some URLs in these sometimes, too.</p>
<p><strong>3) Common mistakes</strong>: The last element of project context that I try to keep around is any hard-won optimizations or understandings. For example, in <a href="https://github.com/simonpcouch/predictive/blob/859755e8bdb3ad381b46cf6f3dfbe2c2aa564ff0/CLAUDE.md#L48">an LLM-based app I‚Äôve been working on recently</a>, I have this instruction:</p>
<blockquote class="blockquote">
<p>The app uses <code><a href="https://rdrr.io/pkg/shiny/man/ExtendedTask.html">shiny::ExtendedTask</a></code> for the chat streaming process to keep the UI responsive while the LLM generates responses. The ExtendedTask wraps the entire streaming pipeline from tool execution through text generation. <strong>The streaming of text from the model is itself the ExtendedTask</strong>; while the LLM responds to the user, the app is able to respond to other reactives while tokens stream in.</p>
</blockquote>
<p>While working on this app, I found again and again that the model misinterpreted why the ExtendedTask functionality was being used and the consequences of removing it. Once I had communicated this clearly in one session, I said something like ‚ÄúDocument your learnings about how ExtendedTasks are used in this app.‚Äù</p>
<p>In my first experiences using Claude Code, I mostly thought of these CLAUDE.md documents as relatively static; once the model knows my preferences and the build and test commands, it‚Äôs smooth sailing. As I‚Äôve spent more time with the tool, I‚Äôve found that it‚Äôs much more useful to treat them as living documents, where I continue to document how functionality works as I implement it.</p>
</section><section id="user-context" class="level3"><h3 class="anchored" data-anchor-id="user-context">User context</h3>
<p>Regardless of which project I‚Äôm working on, there are some style elements of code that Claude Code writes that I always want to change. The context on these project-agnostic preferences live in a CLAUDE.md file in the directory where I keep all of my R projects. I‚Äôll refrain from leaving the full prompt here (your preferences are different than mine!), but here‚Äôs one example of the kind of guidance I have in there:</p>
<blockquote class="blockquote">
<p>In general, place user-facing functions at the top of files, and then helpers below them. For helpers used inside of helpers, place them even further down. Generally, do not define functions inside of functions unless they are very brief, anonymous functions. For example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># good</span></span>
<span><span class="va">main_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu">helper_function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">processed</span>, <span class="va">scaled</span><span class="op">)</span></span>
<span> <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">helper_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">res</span>, scaled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># bad</span></span>
<span><span class="va">main_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="va">helper_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>   <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">res</span>, scaled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>   <span class="va">res</span></span>
<span> <span class="op">}</span></span>
<span> </span>
<span> <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu">helper_function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">processed</span>, <span class="va">scaled</span><span class="op">)</span></span>
<span> <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># bad</span></span>
<span><span class="va">helper_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">res</span>, scaled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">main_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu">helper_function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">processed</span>, <span class="va">scaled</span><span class="op">)</span></span>
<span> <span class="va">res</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</blockquote>
<p>In addition to code style preferences, there‚Äôs also a bunch of guidance on testing based on the <a href="https://github.com/simonpcouch/ensure/blob/main/inst/system_prompt.md">system prompt</a> of a tool I experimented with earlier in the year and some incantations to try and reduce sycophancy.</p>
<p>As I mentioned in my last post, Claude Code loves to add code comments saying <em>what</em> it‚Äôs doing rather than <em>why</em>. I don‚Äôt see much value in these comments, but it‚Äôs also still remarkably difficult to get it to not add them. One trick I saw somewhere on the internet that works (sometimesüò∂) is to have the model repeat back to you what it read, affirming that it won‚Äôt add those comments:</p>
<blockquote class="blockquote">
<p>Do not add new code comments when editing files. Do not remove existing code comments unless you‚Äôre also removing the functionality that they explain. After reading this instruction, note to the user that you‚Äôve read it and will not be adding new code comments when you propose file edits.</p>
</blockquote>
<p>I also include a few examples of code with comments vs.&nbsp;without, because apparently this is a really hard problem.</p>
</section><section id="workflow" class="level3"><h3 class="anchored" data-anchor-id="workflow">Workflow</h3>
<p>While the contents of all of your CLAUDE.md files will be placed in Claude Code‚Äôs context window, the model will not have a chance to take any actions based on the context. Specifically, if I place those references to URLs and help-files in the context, the model won‚Äôt have actually read those web pages and documentation entries when I start up Claude Code. Instead, we need to explicitly say ‚Äúgo read up on the references in your context.‚Äù</p>
<p>Claude Code supports ‚Äúslash commands‚Äù that allow you to create short-hands for these sorts of common prompts. They‚Äôre just markdown files in a special directory; here‚Äôs the one that I use:</p>
<pre><code>mkdir -p ~/.claude/commands
echo "Read up on the documentation entries and web pages noted in your context using the provided tools." &gt; ~/.claude/commands/read-up.md</code></pre>
<p>Then, when I run <code>claude</code> (or <code>/compact</code>) in the future and type <code>/</code>, the first auto-completed suggestion is <code>read-up</code>:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="slash-command.png" class="img-fluid figure-img" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);;width:100.0%" alt="A screenshot of a Claude Code terminal. In the user submission box, I've typed '/', and the suggestion immediately below reflects the `read-up` command I just added."></p>
</figure>
</div>
</div>
</div>
<p>Running it will inject that prompt, and the model will begin tool calling for the web pages and documentation entries noted in its system context:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="slash-command-2.png" class="img-fluid figure-img" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);;width:100.0%" alt="A screenshot of a Claude Code terminal. The top reads 'read-up is running...' and two tool calls fetching the documentation for related packages are shown below."></p>
</figure>
</div>
</div>
</div>
<p>Depending on the project, this might take 10 to 30 seconds, but 1) I don‚Äôt have to pay attention at all while it does so and 2) that‚Äôs much less time than if I were to build up context with the model interactively. Usually, those tool calls have completed by the time I‚Äôm able to type out my first prompt. (If I finish typing the prompt before the tool calls are finished, I usually take it as an opportunity to explain what I want to do more thoroughly than I otherwise would.)</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It‚Äôs true that we could also write something like a <code>CLAUDE.Rmd</code>, which would just render the full <code>.R</code> file contents and tool call results statically. I gave this a go but found that 1) it was annoying to make sure I was rendering it often enough and 2) Claude would still tool call for those docs a second time sometimes? Actually calling the tool itself seems to more clearly ‚Äúregister‚Äù with the model that it‚Äôs seen a piece of documentation.</p>
</div>
</div>
<p>Other miscellaneous workflow patterns:</p>
<ul>
<li>Apparently some folks manage to have several different Claude Code instances running at the same time, or whatever. Not my thing‚ÄîI never use more than one instance at once, and usually I‚Äôm reading and occasionally editing other files as I use it.</li>
<li>I almost never auto-accept edits except for the most fun-little-throwaway-programs.</li>
<li>I do auto-accept tool calls for package documentation. If you want to do the same, type <code>/allowed-tools</code> and configure from there.</li>
<li>There‚Äôs a Claude Code OpenVSX extension that renders diffs in your editor pane rather than in the terminal. After a couple days of trying it, I found it too annoying that the focus would move to the suggested edits while I was in the middle of typing in some other file‚Äîresulting in spare characters left in one or both files‚Äîand I uninstalled it.</li>
</ul></section></section><section id="section" class="level2"><h2 class="anchored" data-anchor-id="section">üí∞üí∞üí∞</h2>
<p>In my previous post, I wrote that I had spent about $25 on my Claude Code API key in the previous month, and that I thought $100 per hour (as the website suggested at the time was possible with ‚Äúintensive use‚Äù) was bonkers.</p>
<p>So, my personal costs? All that additional context must be expensive right? <strong>So far in July (it‚Äôs the 17th), I‚Äôve spent $45 on my Claude Code API key.</strong> So, yes, more expensive than it was previously. In the last two months, the most I‚Äôve spent on that key in a day was $11, and I don‚Äôt use the key at all once or twice a work week. A typical day is something like $4.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ccusage.png" class="img-fluid figure-img" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);;width:100.0%" alt="A screenshot of the Anthropic API console. A bar graph shows the cost by day over the last two weeks by model. Most of my usage is Claude Sonnet 4, with highly variable heights depending on the day."></p>
</figure>
</div>
</div>
</div>
<p>Interestingly, Anthropic‚Äôs documentation on expected costs has changed, a bit too:</p>
<blockquote class="blockquote">
<p>Claude Code consumes tokens for each interaction. The average cost is $6 per developer per day, with daily costs remaining below $12 for 90% of users.</p>
<p>For team usage, Claude Code charges by API token consumption. On average, Claude Code costs ~$50-60/developer per month with Sonnet 4 though there is large variance depending on how many instances users are running and whether they‚Äôre using it in automation.</p>
</blockquote>
<p>So, sounds like I‚Äôm the most regular-degular Claude Coder there ever was. This also smells more data-centric than the old wording? I wonder if this is an explicit counter to the ‚ÄúClaude Code is so expensive‚Äù narrative.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Your feelings on what is A Lot Of Money to spend on LLMs likely differ from mine. I write software for a living, and I do so in the USA, both of which greatly effect what I think of as ‚Äúcheap.‚Äù</p>
</div>
</div>
</section><section id="context-management" class="level2"><h2 class="anchored" data-anchor-id="context-management">Context management</h2>
<p>A rant from Slack a few days ago:</p>
<blockquote class="blockquote">
<p>It sort of surprises me that <code>/compact</code> in Claude Code is as bad as it is? I often find that <code>/compact</code> is almost catastrophic in terms of how helpful the tool is before vs.&nbsp;after the action; I have to do all the same steps in building the context that made the tool helpful back up every time it happens, and I lose recent ‚Äúcheckpoints‚Äù in the conversation that I‚Äôd otherwise want to refer to.</p>
<p>I would much prefer that, instead of summarizing all 200,000 tokens into 500 or so, Haiku would a) choose 5-10 tool call results that weren‚Äôt that helpful to remove (or summarize in a sentence), or b) choose a pair of turn indices inside which to pare back into a few sentences. This would pare the conversation back to, say, 100,000 tokens, always preserving the most recent 10 or so turns.</p>
</blockquote>
<p>I feel like there must be something I‚Äôm missing. Poking around in the docs now, I see there‚Äôs <a href="https://docs.anthropic.com/en/docs/claude-code/hooks#precompact">a <code>PreCompact</code> hook</a>‚ÄîI‚Äôm definitely interested in spending some time with that. We‚Äôre spending some time on better default behavior in our own packages, as well.</p>
<p>Altogether, though, I‚Äôve been really enjoying using Claude Code recently. Being intentional about my workflows and reducing friction helped me get much more out of it, as is the case with so many coding tools.</p>
<hr>
<p><em>Conversations with Hannah Frick, Malcolm Barrett, and Joshua Yamamoto helped me solidify some of the ideas in this post. Garrick Aden-Buie is to thank for the <a href="https://posit-dev.github.io/btw/">btw</a> package, and Winston Chang and Charlie Gao were instrumental in tightening up <a href="https://posit-dev.github.io/mcptools/">our support for MCP</a> in R.</em></p>


</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/simonpcouch\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://utteranc.es/client.js" repo="simonpcouch/website" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>¬© 2024 Simon P. Couch ‚àô Made with <a href="https://quarto.org">Quarto</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>